rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ğŸ”¹ ëˆ„êµ¬ë‚˜ ì½ê¸° ê°€ëŠ¥í•œ ì»¬ë ‰ì…˜ë“¤
    match /banners/{bannerId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    match /weather/{weatherId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    match /board/{boardId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    match /countries/{countryId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    match /faq/{faqId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    match /menu_feedback/{feedbackId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    match /singo/{singoId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // ğŸ”¹ tripfriends_users ì»¬ë ‰ì…˜ì—ì„œ íŠ¹ì • ì „í™”ë²ˆí˜¸ ê²€ìƒ‰ í—ˆìš©
    match /tripfriends_users/{userId} {
      allow read: if true;  // ë¡œê·¸ì¸ ì—†ì´ë„ ê°œë³„ ë¬¸ì„œ ì¡°íšŒ ê°€ëŠ¥
      
      // tripfriends_usersì˜ ì„œë¸Œì»¬ë ‰ì…˜ reviewsì— ëŒ€í•œ ê·œì¹™ ì¶”ê°€
      match /reviews/{reviewId} {
        allow read: if true;  // ë¦¬ë·°ë„ ë¡œê·¸ì¸ ì—†ì´ ì½ê¸° ê°€ëŠ¥
        allow write: if request.auth != null;  // ì“°ê¸°ëŠ” ì¸ì¦ëœ ì‚¬ìš©ìë§Œ
      }
    }
    
    // ğŸ”¹ tripfriends_users ì „ì²´ ëª©ë¡ì„ ê°€ì ¸ê°€ëŠ” list
    match /tripfriends_users {
      allow list: if true;
    }
    
    // ğŸ”¹ users_test ì»¬ë ‰ì…˜ - ì‚¬ìš©ìëŠ” ìì‹ ì˜ ë°ì´í„°ë§Œ ì½ê³  ì“¸ ìˆ˜ ìˆìŒ
    match /users_test/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // ğŸ”¹ posts ì»¬ë ‰ì…˜ - ê²Œì‹œë¬¼ ê´€ë ¨ ê·œì¹™
    match /posts/{postId} {
      // ì½ê¸°: ê³µê°œëœ ê²Œì‹œë¬¼(isVisible: true)ì€ ëˆ„êµ¬ë‚˜ ë³¼ ìˆ˜ ìˆìŒ
      allow read: if resource.data.isVisible == true;
      
      // ìƒì„±: ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ê²Œì‹œë¬¼ ìƒì„± ê°€ëŠ¥, userIdëŠ” ë³¸ì¸ ê²ƒë§Œ
      allow create: if request.auth != null 
                    && request.auth.uid == request.resource.data.userId
                    && request.resource.data.keys().hasAll(['userId', 'content', 'createdAt', 'isVisible'])
                    && request.resource.data.isVisible is bool
                    && request.resource.data.userId is string
                    && request.resource.data.content is string;
      
      // ìˆ˜ì •: ë³¸ì¸ ê²Œì‹œë¬¼ë§Œ ìˆ˜ì • ê°€ëŠ¥, ì¤‘ìš” í•„ë“œëŠ” ë³€ê²½ ë¶ˆê°€
      allow update: if request.auth != null 
                    && request.auth.uid == resource.data.userId
                    && request.auth.uid == request.resource.data.userId  // userId ë³€ê²½ ë¶ˆê°€
                    && resource.data.createdAt == request.resource.data.createdAt;  // ìƒì„±ì¼ ë³€ê²½ ë¶ˆê°€
      
      // ì‚­ì œ: ë³¸ì¸ ê²Œì‹œë¬¼ë§Œ ì‚­ì œ ê°€ëŠ¥
      allow delete: if request.auth != null 
                    && request.auth.uid == resource.data.userId;
                    
      // ğŸ”¹ postsì˜ ì„œë¸Œì»¬ë ‰ì…˜ë“¤ (ëŒ“ê¸€, ì¢‹ì•„ìš” ë“±)
      match /comments/{commentId} {
        // ëŒ“ê¸€ ì½ê¸°: ë¶€ëª¨ ê²Œì‹œë¬¼ì´ ê³µê°œëœ ê²½ìš°ë§Œ
        allow read: if get(/databases/$(database)/documents/posts/$(postId)).data.isVisible == true;
        
        // ëŒ“ê¸€ ì‘ì„±: ì¸ì¦ëœ ì‚¬ìš©ìë§Œ, ë¶€ëª¨ ê²Œì‹œë¬¼ì´ ê³µê°œëœ ê²½ìš°ë§Œ
        allow create: if request.auth != null 
                      && get(/databases/$(database)/documents/posts/$(postId)).data.isVisible == true
                      && request.auth.uid == request.resource.data.userId;
        
        // ëŒ“ê¸€ ìˆ˜ì •/ì‚­ì œ: ë³¸ì¸ ëŒ“ê¸€ë§Œ
        allow update, delete: if request.auth != null 
                              && request.auth.uid == resource.data.userId;
      }
      
      match /likes/{likeId} {
        // ì¢‹ì•„ìš” ì½ê¸°: ë¶€ëª¨ ê²Œì‹œë¬¼ì´ ê³µê°œëœ ê²½ìš°ë§Œ
        allow read: if get(/databases/$(database)/documents/posts/$(postId)).data.isVisible == true;
        
        // ì¢‹ì•„ìš” ì¶”ê°€/ì œê±°: ì¸ì¦ëœ ì‚¬ìš©ìë§Œ, ë³¸ì¸ ì¢‹ì•„ìš”ë§Œ
        allow create, delete: if request.auth != null 
                              && request.auth.uid == likeId
                              && get(/databases/$(database)/documents/posts/$(postId)).data.isVisible == true;
      }
    }
    
    // ğŸ”¹ ë‚˜ë¨¸ì§€ ëª¨ë“  ë¬¸ì„œëŠ” ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ì ‘ê·¼ ê°€ëŠ¥
    match /{document=**} {
      allow read, write: if true;
    }
  }
}
